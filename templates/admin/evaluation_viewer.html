{% extends "base.html" %}

{% block title %}Evaluation Viewer{% endblock %}

{% block extra_css %}
<style>
    .evaluation-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,.08);
    }
    
    .evaluation-header {
        border-bottom: 2px solid var(--admin-primary);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .uat-item {
        border-left: 3px solid var(--admin-info);
        background: #f8f9fa;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .product-item {
        border-left: 3px solid var(--admin-warning);
        background: #fffbf0;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .navigation-bar {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        padding: 1rem 0;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 2rem;
    }
    
    .filter-badge {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-badge:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<!-- Search and Navigation Bar -->
<div class="navigation-bar">
    <div class="row align-items-center">
        <div class="col-md-6">
            <form method="get" action="/evaluations/viewer" class="d-flex">
                <input type="text" 
                       name="search" 
                       class="form-control search-box me-2" 
                       placeholder="Search UAT numbers, keywords, phrases..." 
                       value="{{ search_query }}">
                {% if evaluation %}
                <input type="hidden" name="id" value="{{ evaluation.get('evaluation_id', evaluation.get('id')) }}">
                {% endif %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
        <div class="col-md-3">
        </div>
        <div class="col-md-3 text-end">
            {% if evaluation %}
            <div class="btn-group" role="group">
                {% if prev_id %}
                <a href="/evaluations/viewer?id={{ prev_id }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="btn btn-outline-primary nav-button" 
                   title="Previous">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% else %}
                <button class="btn btn-outline-secondary nav-button" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                {% endif %}
                
                <span class="btn btn-outline-secondary disabled">
                    {{ current_index }} / {{ total_count }}
                </span>
                
                {% if next_id %}
                <a href="/evaluations/viewer?id={{ next_id }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="btn btn-outline-primary nav-button" 
                   title="Next">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-outline-secondary nav-button" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if error %}
<!-- Error Message -->
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
</div>
{% elif evaluation %}
<!-- Evaluation Details -->
<div class="evaluation-section">
    <div class="evaluation-header">
        <div class="row">
            <div class="col-md-8">
                <h3>
                    <i class="fas fa-file-alt me-2"></i>
                    Evaluation Details
                </h3>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar me-1"></i>{{ evaluation.timestamp[:19] if evaluation.timestamp else 'N/A' }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" 
                        class="btn btn-danger" 
                        onclick="confirmDelete('{{ evaluation.get('evaluation_id', evaluation.get('id')) }}')">
                    <i class="fas fa-trash-alt me-1"></i>Delete Evaluation
                </button>
            </div>
        </div>
    </div>
    
    <!-- Timestamp -->
    <div class="row mb-3">
        <div class="col-md-6">
            <strong><i class="fas fa-calendar me-2"></i>Timestamp:</strong>
            {{ evaluation.timestamp }}
        </div>
        <div class="col-md-6">
            <strong><i class="fas fa-robot me-2"></i>AI Source:</strong>
            <span class="badge bg-info">{{ evaluation.get('system_analysis', {}).get('source', evaluation.get('context', {}).get('source', 'Unknown'))|title }}</span>
        </div>
    </div>
</div>

<!-- User Input Section -->
<div class="evaluation-section">
    <h4 class="mb-3"><i class="fas fa-user-edit me-2"></i>User Input</h4>
    
    <div class="mb-3">
        <strong>Issue Title:</strong>
        <p class="ms-3">{{ evaluation.get('original_issue', {}).get('title', evaluation.get('user_input', {}).get('issue_title', 'N/A')) }}</p>
    </div>
    
    <div class="mb-3">
        <strong>Issue Description:</strong>
        <div class="ms-3 p-3 bg-light rounded">
            {{ evaluation.get('original_issue', {}).get('description', evaluation.get('user_input', {}).get('issue_description', 'N/A')) }}
        </div>
    </div>
    
    {% if evaluation.get('original_issue', {}).get('impact') or evaluation.get('user_input', {}).get('expected_behavior') %}
    <div class="mb-3">
        <strong>Expected Behavior:</strong>
        <div class="ms-3 p-3 bg-light rounded">
            {{ evaluation.get('original_issue', {}).get('impact', evaluation.get('user_input', {}).get('expected_behavior', '')) }}
        </div>
    </div>
    {% endif %}
</div>

<!-- AI Analysis Section -->
<div class="evaluation-section">
    <h4 class="mb-3"><i class="fas fa-brain me-2"></i>AI Analysis Results</h4>
    
    <div class="row mb-3">
        <div class="col-md-4">
            <strong>Detected Category:</strong>
            <p class="ms-3">
                <span class="badge bg-primary fs-6">
                    {{ evaluation.get('system_analysis', {}).get('category', evaluation.get('detected_category', 'Unknown')) }}
                </span>
            </p>
        </div>
        <div class="col-md-4">
            <strong>Detected Feature:</strong>
            <p class="ms-3">
                <span class="badge bg-secondary fs-6">
                    {{ evaluation.get('system_analysis', {}).get('feature', evaluation.get('detected_feature', 'None')) }}
                </span>
            </p>
        </div>
        <div class="col-md-4">
            <strong>Confidence Score:</strong>
            <p class="ms-3">
                <span class="badge bg-success fs-6">
                    {{ "%.0f"|format((evaluation.get('system_analysis', {}).get('confidence', evaluation.get('context', {}).get('confidence', 0)) or 0) * 100) }}%
                </span>
            </p>
        </div>
    </div>
    
    {% if evaluation.get('system_analysis', {}).get('reasoning') or evaluation.get('context', {}).get('reasoning') %}
    <div class="mb-3">
        <strong>AI Reasoning:</strong>
        <div class="ms-3 p-3 bg-light rounded">
            {{ evaluation.get('system_analysis', {}).get('reasoning', evaluation.get('context', {}).get('reasoning', '')) }}
        </div>
    </div>
    {% endif %}
</div>

<!-- Suggested UATs Section -->
<div class="evaluation-section">
    <h4 class="mb-3">
        <i class="fas fa-clipboard-check me-2"></i>
        Suggested UATs ({{ evaluation.get('suggested_uats', [])|length }})
    </h4>
    
    {% if evaluation.get('suggested_uats') %}
    {% for uat in evaluation.get('suggested_uats', []) %}
    <div class="uat-item">
        <div class="row">
            <div class="col-md-9">
                <h5 class="mb-2">
                    {% if uat.ado_link %}
                    <a href="{{ uat.ado_link }}" target="_blank" class="text-decoration-none">
                        <span class="badge bg-info">{{ uat.uat_number }}</span>
                        {{ uat.title }}
                        <i class="fas fa-external-link-alt ms-1 small"></i>
                    </a>
                    {% else %}
                    <span class="badge bg-info">{{ uat.uat_number }}</span>
                    {{ uat.title }}
                    {% endif %}
                </h5>
                {% if uat.description %}
                <p class="text-muted mb-2">{{ uat.description[:200] }}...</p>
                {% endif %}
                <div>
                    <small class="text-muted">
                        <i class="fas fa-chart-line me-1"></i>
                        Match Score: <strong>{{ "%.0f"|format((uat.match_score or 0) * 100) }}%</strong>
                    </small>
                </div>
            </div>
            <div class="col-md-3 text-end">
                {% if uat.ado_link %}
                <a href="{{ uat.ado_link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-external-link-alt me-1"></i>View in ADO
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-muted">No UATs suggested</p>
    {% endif %}
</div>

<!-- Detected Products Section -->
{% if evaluation.get('detected_products') %}
<div class="evaluation-section">
    <h4 class="mb-3">
        <i class="fas fa-box me-2"></i>
        Detected Products ({{ evaluation.get('detected_products', [])|length }})
    </h4>
    
    {% for product in evaluation.get('detected_products', []) %}
    <div class="product-item">
        <strong>{{ product.name }}</strong>
        <span class="badge bg-warning text-dark ms-2">
            {{ "%.0f"|format((product.confidence or 0) * 100) }}% confidence
        </span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- User Corrections Section -->
{% if evaluation.get('corrections') or evaluation.get('user_corrections') %}
<div class="evaluation-section">
    <h4 class="mb-3 text-danger">
        <i class="fas fa-edit me-2"></i>
        User Corrections Applied
    </h4>
    
    {% if evaluation.get('corrections', {}).get('correct_category') or evaluation.get('user_corrections', {}).get('correct_category') %}
    <div class="mb-2">
        <strong>Corrected Category:</strong>
        <span class="badge bg-danger ms-2">
            {{ evaluation.get('corrections', {}).get('correct_category', evaluation.get('user_corrections', {}).get('correct_category', '')) }}
        </span>
    </div>
    {% endif %}
    
    {% if evaluation.get('corrections', {}).get('feedback') or evaluation.get('user_corrections', {}).get('feedback') %}
    <div class="mb-2">
        <strong>User Feedback:</strong>
        <div class="ms-3 p-3 bg-light rounded">
            {{ evaluation.get('corrections', {}).get('feedback', evaluation.get('user_corrections', {}).get('feedback', '')) }}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="alert alert-info text-center">
    <i class="fas fa-search fa-3x mb-3"></i>
    <h4>No Evaluation Selected</h4>
    <p>Use the search box above or <a href="/evaluations">view the evaluations list</a></p>
</div>
{% endif %}

<script>
function confirmDelete(evalId) {
    if (confirm('Are you sure you want to delete this evaluation? This action cannot be undone.')) {
        fetch(`/evaluations/${evalId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evaluation deleted successfully');
                window.location.href = '/evaluations';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting evaluation: ' + error);
        });
    }
}
</script>

{% endblock %}
