{% extends "base.html" %}

{% block title %}Evaluations List{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-clipboard-list me-2"></i>Evaluations List</h2>
        <p class="text-muted">Browse and filter all evaluation records</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="/evaluations" class="row g-3">
            <div class="col-md-6">
                <input type="text" 
                       name="search" 
                       class="form-control search-box" 
                       placeholder="Search UAT numbers, keywords, or phrases..." 
                       value="{{ search_query }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results Summary -->
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    Showing <strong>{{ evaluations|length }}</strong> of <strong>{{ total }}</strong> evaluations
    {% if search_query %}
    matching "<strong>{{ search_query }}</strong>"
    {% endif %}
</div>

<!-- Evaluations Table -->
{% if evaluations %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Category</th>
                        <th>Feature</th>
                        <th>UATs</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in evaluations %}
                    <tr>
                        <td>
                            <small class="text-muted">
                                {{ eval.timestamp[:19] if eval.timestamp else 'N/A' }}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-primary">
                                {{ eval.detected_category or 'Unknown' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ eval.detected_feature or 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info">
                                {{ eval.suggested_uats|length }} UATs
                            </span>
                        </td>
                        <td>
                            {{ "%.0f"|format((eval.get('system_analysis', {}).get('confidence', 0) or eval.get('confidence', 0)) * 100) }}%
                        </td>
                        <td>
                            <a href="/evaluations/viewer?id={{ eval.get('evaluation_id', eval.get('id')) }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                               class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger" 
                                    onclick="confirmDelete('{{ eval.get('evaluation_id', eval.get('id')) }}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="/evaluations?page={{ page - 1 }}&per_page={{ per_page }}{% if search_query %}&search={{ search_query }}{% endif %}">
                Previous
            </a>
        </li>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
        <li class="page-item">
            <a class="page-link" href="/evaluations?page={{ p }}&per_page={{ per_page }}{% if search_query %}&search={{ search_query }}{% endif %}&status={{ filter_status }}">
                {{ p }}
            </a>
        </li>
        {% elif p == 4 or p == total_pages - 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}
        
        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="/evaluations?page={{ page + 1 }}&per_page={{ per_page }}{% if search_query %}&search={{ search_query }}{% endif %}&status={{ filter_status }}">
                Next
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-warning text-center">
    <i class="fas fa-search fa-3x mb-3"></i>
    <h4>No Evaluations Found</h4>
    <p>Try adjusting your search or filter criteria</p>
</div>
{% endif %}

<script>
function confirmDelete(evalId) {
    if (confirm('Are you sure you want to delete this evaluation? This action cannot be undone.')) {
        fetch(`/evaluations/${evalId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the current page to refresh the list
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting evaluation: ' + error);
        });
    }
}
</script>

{% endblock %}
