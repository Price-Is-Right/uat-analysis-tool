{% extends "base.html" %}

{% block title %}Application Logs{% endblock %}

{% block extra_css %}
<style>
    .log-entry {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        padding: 8px;
        border-left: 3px solid #6c757d;
        margin-bottom: 8px;
        background: #f8f9fa;
    }
    .log-error { border-left-color: #dc3545; background: #f8d7da; }
    .log-warning { border-left-color: #ffc107; background: #fff3cd; }
    .log-info { border-left-color: #0dcaf0; background: #d1ecf1; }
    .log-debug { border-left-color: #6c757d; background: #e2e3e5; }
    
    .timestamp {
        color: #6c757d;
        font-weight: bold;
    }
    .level {
        padding: 2px 8px;
        border-radius: 3px;
        font-weight: bold;
        margin: 0 8px;
    }
    .level-error { background: #dc3545; color: white; }
    .level-warning { background: #ffc107; color: black; }
    .level-info { background: #0dcaf0; color: black; }
    .level-debug { background: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <a href="/" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-file-alt me-2"></i>Application Logs</h2>
                <p class="text-muted">View logs from Azure Log Analytics workspace</p>
            </div>
            <button class="btn btn-primary" onclick="refreshLogs()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label">Time Range</label>
        <select class="form-select" id="timeRange" onchange="refreshLogs()">
            <option value="1h">Last 1 Hour</option>
            <option value="6h" selected>Last 6 Hours</option>
            <option value="24h">Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Log Level</label>
        <select class="form-select" id="logLevel" onchange="filterLogs()">
            <option value="all">All Levels</option>
            <option value="error">Error</option>
            <option value="warning">Warning</option>
            <option value="info">Info</option>
            <option value="debug">Debug</option>
        </select>
    </div>
    <div class="col-md-6">
        <label class="form-label">Search</label>
        <input type="text" class="form-control" id="logSearch" placeholder="Search logs..." oninput="filterLogs()">
    </div>
</div>

<!-- Log Entries -->
<div class="card">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Log Entries 
            <span class="badge bg-secondary ms-2" id="logCount">0</span>
        </h5>
    </div>
    <div class="card-body" style="max-height: 700px; overflow-y: auto;">
        <div id="logs-container">
            {% if logs_enabled %}
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading logs from Azure Log Analytics...</p>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Azure Log Analytics Not Configured</strong>
                <p class="mb-0 mt-2">To enable log viewing, configure the following:</p>
                <ul class="mt-2">
                    <li>AZURE_LOG_ANALYTICS_WORKSPACE_ID in Azure Key Vault</li>
                    <li>Install required packages: <code>pip install azure-monitor-query</code></li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const MOCK_LOGS = [
    { timestamp: new Date().toISOString(), level: 'info', message: 'Admin service started successfully', service: 'admin-service' },
    { timestamp: new Date(Date.now() - 300000).toISOString(), level: 'info', message: 'User accessed evaluations list', service: 'admin-service' },
    { timestamp: new Date(Date.now() - 600000).toISOString(), level: 'warning', message: 'Slow query detected: 1.5s', service: 'search-service' },
    { timestamp: new Date(Date.now() - 900000).toISOString(), level: 'info', message: 'Context analysis completed', service: 'context-analyzer' },
    { timestamp: new Date(Date.now() - 1200000).toISOString(), level: 'error', message: 'Failed to connect to Azure OpenAI', service: 'context-analyzer' },
];

let allLogs = [];

async function refreshLogs() {
    const container = document.getElementById('logs-container');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-3 text-muted">Loading logs...</p></div>';
    
    try {
        // In production, fetch from Azure Log Analytics
        // const response = await fetch('/api/logs?range=' + document.getElementById('timeRange').value);
        // allLogs = await response.json();
        
        // For now, use mock data
        allLogs = MOCK_LOGS;
        
        displayLogs(allLogs);
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Error loading logs: ${error.message}</div>`;
    }
}

function displayLogs(logs) {
    const container = document.getElementById('logs-container');
    document.getElementById('logCount').textContent = logs.length;
    
    if (logs.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center">No logs found for the selected time range</div>';
        return;
    }
    
    container.innerHTML = logs.map(log => {
        const levelClass = `log-${log.level}`;
        const badgeClass = `level-${log.level}`;
        const time = new Date(log.timestamp).toLocaleString();
        
        return `
            <div class="log-entry ${levelClass}" data-level="${log.level}">
                <span class="timestamp">[${time}]</span>
                <span class="level ${badgeClass}">${log.level.toUpperCase()}</span>
                <span class="service badge bg-secondary">${log.service}</span>
                <span class="message">${log.message}</span>
            </div>
        `;
    }).join('');
}

function filterLogs() {
    const level = document.getElementById('logLevel').value;
    const search = document.getElementById('logSearch').value.toLowerCase();
    
    const filtered = allLogs.filter(log => {
        const matchesLevel = level === 'all' || log.level === level;
        const matchesSearch = !search || log.message.toLowerCase().includes(search) || log.service.toLowerCase().includes(search);
        return matchesLevel && matchesSearch;
    });
    
    displayLogs(filtered);
}

// Initial load
{% if logs_enabled %}
refreshLogs();
{% endif %}
</script>

{% endblock %}
