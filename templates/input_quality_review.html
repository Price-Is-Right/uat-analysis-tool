{% extends "base.html" %}

{% block title %}Input Quality Review{% endblock %}

<!-- Override navbar to remove Home/Admin links during quality review -->
{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <span class="navbar-brand">
            <i class="fas fa-headset me-2"></i>Issue Tracker System
        </span>
        <div class="navbar-nav ms-auto">
            <span class="nav-link text-light">
                <i class="fas fa-clipboard-check me-1"></i>Step 2: Quality Review
            </span>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header {{ 'bg-success text-white' if quality.completeness_score >= 80 else 'bg-info text-white' }}">
                    <h4 class="mb-0">
                        <i class="fas {{ 'fa-check-circle' if quality.completeness_score >= 80 else 'fa-eye' }} me-2"></i>Final Review & Quality Check
                    </h4>
                </div>
                <div class="card-body">
                    {% if quality.completeness_score >= 80 %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Your submission quality is good!</strong>
                            You can proceed with your current submission, or review and make any final improvements below before continuing.
                        </div>
                    {% elif quality.garbage_detected and quality.completeness_score < 50 %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Invalid input detected!</strong>
                            Our system detected that some of your input appears to be random characters or meaningless text. Please provide clear, descriptive information about your issue so we can help you effectively.
                        </div>
                    {% elif quality.completeness_score < 50 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>More information needed</strong>
                            Your submission needs additional details for our AI to provide effective assistance. Please review the suggestions below and add more context.
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                             <i class="fas fa-info-circle me-2"></i>
                            <strong>Almost there!</strong>
                            Your submission is {{ quality.completeness_score }}% complete. Review the suggestions below to improve the quality of your submission.
                        </div>
                    {% endif %}
                    
                    <!-- Quality Score -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Completeness Score:</label>
                        <div class="progress quality-progress">
                            <div class="progress-bar bg-{{ 'danger' if quality.completeness_score < 50 else 'warning' if quality.completeness_score < 80 else 'success' }}" 
                                 role="progressbar" 
                                 style="width: {{ quality.completeness_score }}%"
                                 aria-label="Completeness Score {{ quality.completeness_score }}%">
                                {{ quality.completeness_score }}%
                            </div>
                        </div>
                        {% if quality.completeness_score >= 80 %}
                            <small class="text-success fw-bold">✅ Great! Your submission has enough information for our AI to provide effective assistance</small>
                        {% elif is_second_attempt and show_proceed_warning %}
                            <small class="text-warning-accessible fw-bold">⚠️ Your submission is {{ quality.completeness_score }}% complete, which is below the suggested 80%. This may hinder getting the most applicable help. You can proceed anyway or edit again.</small>
                        {% else %}
                            <small class="text-muted">We need at least 80% completeness for our AI to provide effective assistance</small>
                        {% endif %}
                    </div>

                    <!-- Current Submission -->
                    <div class="mb-4">
                        <h5 class="text-muted">
                            <i class="fas fa-file-alt me-2"></i>Your Current Submission
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Title:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ title or 'No title provided' }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ description or 'No description provided' }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Impact:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ impact or 'No impact statement provided' }}
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions for Improvement (only show if quality < 90%) -->
                    {% if quality.completeness_score < 90 %}
                    <div class="mb-4">
                        <h5 class="text-danger">
                            <i class="fas fa-lightbulb me-2"></i>Suggestions for Improvement
                        </h5>
                        
                        {% if quality.suggestions %}
                            <div class="list-group">
                                {% for suggestion in quality.suggestions %}
                                    <div class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>{{ suggestion }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Review/Edit Form (only show if quality < 90%) -->
                    {% if quality.completeness_score < 90 %}
                    <div class="card bg-light">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2"></i>Please Improve Your Submission
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('submit_issue') }}">
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-bold">
                                        Title <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Be specific about your issue or request (e.g., "Login button not working on Chrome browser" or "Need additional Azure licenses for team")</small>
                                    </label>
                                    <input type="text" 
                                           class="form-control {{ 'is-invalid' if 'title' in quality.issues|join(' ') else '' }}" 
                                           id="title" 
                                           name="title" 
                                           value="{{ title }}" 
                                           maxlength="125"
                                           placeholder="Specific, descriptive title of your issue or request">
                                    <div class="form-text" id="title-counter">
                                        <i class="fas fa-keyboard me-1"></i>
                                        <span id="title-count">{{ title|length if title else 0 }}</span>/125 characters
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label fw-bold">
                                        Description <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Describe your situation, issue, or request with enough context for our AI to understand and help you effectively (minimum {{ min_words }} words)</small>
                                    </label>
                                    <textarea class="form-control {{ 'is-invalid' if 'description' in quality.issues|join(' ') else '' }}" 
                                              id="description" 
                                              name="description" 
                                              rows="4" 
                                              placeholder="Detailed description of your situation, issue, or request with sufficient context for understanding">{{ description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="impact" class="form-label fw-bold">
                                        Business Impact <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Who is affected and how? Describe the consequences or benefits of resolving this</small>
                                    </label>
                                    <textarea class="form-control {{ 'is-invalid' if 'impact' in quality.issues|join(' ') else '' }}" 
                                              id="impact" 
                                              name="impact" 
                                              rows="3" 
                                              placeholder="Describe who is affected and how - include the consequences of the current situation or benefits of resolving this">{{ impact }}</textarea>
                                </div>
                                
                                <!-- Hidden fields to preserve other data -->
                                <input type="hidden" name="opportunity_id" value="{{ opportunity_id }}">
                                <input type="hidden" name="milestone_id" value="{{ milestone_id }}">
                                <input type="hidden" name="is_second_attempt" value="{{ 'true' if is_second_attempt else 'false' }}">
                                
                                <!-- Hidden fields for action routing -->
                                <input type="hidden" name="action" value="improve" id="form-action">
                                <input type="hidden" name="from_quality_review" value="true">
                                
                                <!-- Three Button Layout: Cancel | Update Input | Continue and Submit -->
                                <div class="d-grid gap-2 mt-4">
                                    <!-- Primary Action: Continue to ICA Analysis -->
                                    {% if quality.completeness_score >= 80 %}
                                        <button type="button" class="btn btn-success btn-lg" id="continueBtn1" onclick="proceedToAnalysis()">
                                            <i class="fas fa-brain me-2"></i>Continue and Submit to Analysis
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="updateInput()">
                                            <i class="fas fa-edit me-2"></i>Update Input
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-outline-success btn-lg" id="continueBtn1" onclick="proceedToAnalysis()" {% if quality.completeness_score < 50 %}disabled title="Quality too low - please improve your input first"{% endif %}>
                                            <i class="fas fa-brain me-2"></i>Continue and Submit to Analysis
                                            {% if quality.completeness_score < 80 %}<small class="d-block">(Not Recommended - {{ quality.completeness_score }}% complete)</small>{% endif %}
                                        </button>
                                        <button type="button" class="btn btn-primary btn-lg" onclick="updateInput()">
                                            <i class="fas fa-edit me-2"></i>Update Input
                                        </button>
                                    {% endif %}
                                    
                                    <!-- Cancel Button -->
                                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons (always show) -->
                    <div class="card mt-4">
                        <div class="card-body">
                            {% if quality.completeness_score >= 90 %}
                                <!-- High Quality: Simple Continue button -->
                                <form method="POST" action="{{ url_for('submit_issue') }}" id="continueForm">
                                    <input type="hidden" name="title" value="{{ title }}">
                                    <input type="hidden" name="description" value="{{ description }}">
                                    <input type="hidden" name="impact" value="{{ impact }}">
                                    <input type="hidden" name="action" value="proceed" id="form-action">
                                    <input type="hidden" name="from_quality_review" value="true">
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-success btn-lg" id="continueBtn">
                                            <i class="fas fa-brain me-2"></i>Continue and Submit to Analysis
                                        </button>
                                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </a>
                                    </div>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div style="text-align: center; color: white;">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; margin-bottom: 1rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4>Starting Intelligent Context Analysis...</h4>
        <p>Please wait while our AI processes your request</p>
    </div>
</div>

<script>
// Show loading overlay when any form is submitted
document.addEventListener('DOMContentLoaded', function() {
    const continueForm = document.getElementById('continueForm');
    if (continueForm) {
        continueForm.addEventListener('submit', function(event) {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            const btn = document.getElementById('continueBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            }
        });
    }
    
    // Also handle the edit form if it exists
    const editForms = document.querySelectorAll('form[action*="submit_issue"]');
    editForms.forEach(function(form) {
        if (form.id !== 'continueForm') {
            form.addEventListener('submit', function(event) {
                const submitButtons = form.querySelectorAll('button[type="button"]');
                submitButtons.forEach(btn => btn.disabled = true);
            });
        }
    });
});

// Handle "Continue and Submit to Analysis" button
function proceedToAnalysis() {
    // Disable all continue buttons to prevent double-click
    const btn1 = document.getElementById('continueBtn1');
    const btn2 = document.getElementById('continueBtn');
    
    if (btn1) {
        btn1.disabled = true;
        btn1.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    }
    if (btn2) {
        btn2.disabled = true;
        btn2.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    }
    
    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Set action to proceed and submit with current data
    document.getElementById('form-action').value = 'proceed';
    
    // Keep the form fields as they are (user's current input)
    // Submit the form to proceed to ICA Analysis
    document.querySelector('form').submit();
}

// Handle "Update Input" button - return to Step 1 with current data
function updateInput() {
    // Redirect to issue submission page with current data
    const form = document.createElement('form');
    form.method = 'GET';
    form.action = '{{ url_for("index") }}';
    
    // Pass current values as URL parameters so Step 1 can pre-fill
    const title = encodeURIComponent(document.getElementById('title').value);
    const description = encodeURIComponent(document.getElementById('description').value);
    const impact = encodeURIComponent(document.getElementById('impact').value);
    
    window.location.href = `{{ url_for("index") }}?title=${title}&description=${description}&impact=${impact}`;
}

// Title character counter
function updateTitleCounter() {
    const titleInput = document.getElementById('title');
    const titleCount = document.getElementById('title-count');
    const titleCounter = document.getElementById('title-counter');
    
    if (titleInput && titleCount && titleCounter) {
        const currentLength = titleInput.value.length;
        titleCount.textContent = currentLength;
        
        // Update styling based on length
        if (currentLength > 100) {
            titleCounter.className = 'form-text text-success';
        } else if (currentLength > 75) {
            titleCounter.className = 'form-text text-info';
        } else {
            titleCounter.className = 'form-text text-muted';
        }
    }
}

// Word count helpers
function updateWordCount(textareaId, minWords) {
    const textarea = document.getElementById(textareaId);
    const words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    
    let badge = document.getElementById(textareaId + '_count');
    if (!badge) {
        badge = document.createElement('small');
        badge.id = textareaId + '_count';
        badge.className = 'badge position-absolute';
        badge.style.top = '5px';
        badge.style.right = '5px';
        textarea.parentNode.style.position = 'relative';
        textarea.parentNode.appendChild(badge);
    }
    
    badge.textContent = `${words} words`;
    badge.className = `badge position-absolute ${words >= minWords ? 'bg-success' : 'bg-warning'}`;
}

// Add word counters
document.addEventListener('DOMContentLoaded', function() {
    // Initialize title counter
    const titleInput = document.getElementById('title');
    if (titleInput) {
        updateTitleCounter();
        titleInput.addEventListener('input', updateTitleCounter);
    }

    const description = document.getElementById('description');
    const impact = document.getElementById('impact');
    
    if (description) {
        updateWordCount('description', {{ min_words }});
        description.addEventListener('input', () => updateWordCount('description', {{ min_words }}));
    }
    
    if (impact) {
        updateWordCount('impact', {{ min_impact_words }});
        impact.addEventListener('input', () => updateWordCount('impact', {{ min_impact_words }}));
    }
});
</script>
{% endblock %}
