{% extends "base.html" %}

{% block title %}Searching Resources - Issue Tracker{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-search me-2"></i>Searching for Helpful Resources</h4>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        We're searching multiple sources to find documentation, alternatives, and guidance that may help resolve your issue.
                    </p>
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Search Progress</h5>
                    
                    <div class="progress-steps">
                        <!-- Step 1: Microsoft Learn -->
                        <div class="step-item" id="step-learn">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3" role="status" id="spinner-learn">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-learn"></i>
                                <div>
                                    <strong>1. Searching Microsoft Learn Documentation</strong>
                                    <div class="small text-muted">Finding relevant articles, tutorials, and guides</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-learn" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 2: Similar Products -->
                        <div class="step-item" id="step-products">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-products">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-products"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-products"></i>
                                <div>
                                    <strong>2. Finding Similar Products & Alternatives</strong>
                                    <div class="small text-muted">Identifying alternative Azure services that might help</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-products" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 3: Regional Availability -->
                        <div class="step-item" id="step-regions">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-regions">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-regions"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-regions"></i>
                                <div>
                                    <strong>3. Checking Regional Availability</strong>
                                    <div class="small text-muted">Finding regions where services are available</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-regions" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 4: Special Guidance -->
                        <div class="step-item" id="step-guidance">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-guidance">
                                    <span class="visually-hidden">Checking...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-guidance"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-guidance"></i>
                                <div>
                                    <strong>4. Checking for Capacity & Retirement Guidance</strong>
                                    <div class="small text-muted">Looking for specific guidance related to your issue type</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-guidance" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 5: Finalizing -->
                        <div class="step-item" id="step-finalize">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-finalize">
                                    <span class="visually-hidden">Finalizing...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-finalize"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-finalize"></i>
                                <div>
                                    <strong>5. Preparing Results</strong>
                                    <div class="small text-muted">Organizing findings for your review</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-finalize" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    {% if deep_search %}
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Deep Search Mode:</strong> Performing comprehensive search across all sources. This may take a bit longer but will provide more thorough results.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel Search
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Auto-redirect script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const steps = ['learn', 'products', 'regions', 'guidance', 'finalize'];
    let currentStep = 0;
    const evalId = '{{ eval_id }}';
    const deepSearch = {{ 'true' if deep_search else 'false' }};
    
    function updateStep(stepName, status) {
        const spinner = document.getElementById('spinner-' + stepName);
        const check = document.getElementById('check-' + stepName);
        const wait = document.getElementById('wait-' + stepName);
        const progress = document.getElementById('progress-' + stepName);
        
        if (status === 'active') {
            if (wait) wait.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
            if (progress) {
                progress.style.width = '50%';
                progress.classList.add('progress-bar-animated');
            }
        } else if (status === 'complete') {
            if (spinner) spinner.classList.add('d-none');
            if (check) check.classList.remove('d-none');
            if (progress) {
                progress.style.width = '100%';
                progress.classList.remove('progress-bar-animated');
                progress.classList.add('bg-success');
            }
        }
    }
    
    // Start background search immediately
    fetch('/perform_search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            eval_id: evalId,
            deep_search: deepSearch
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Search completed successfully');
        } else {
            console.error('Search failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Search error:', error);
    });
    
    function processSteps() {
        if (currentStep < steps.length) {
            updateStep(steps[currentStep], 'active');
            
            // Simulate step completion with realistic timing
            const stepDuration = deepSearch ? 1500 : 1000;
            setTimeout(() => {
                updateStep(steps[currentStep], 'complete');
                currentStep++;
                processSteps();
            }, stepDuration);
        } else {
            // All steps complete, redirect to results
            setTimeout(() => {
                window.location.href = '/search_results?eval_id=' + evalId;
            }, 500);
        }
    }
    
    // Start processing animation
    setTimeout(processSteps, 500);
});
</script>

<style>
.progress-steps {
    max-width: 800px;
    margin: 0 auto;
}

.step-item {
    padding: 15px;
    border-left: 3px solid #e9ecef;
    margin-left: 20px;
}

.step-item:last-child {
    border-left-color: transparent;
}

.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease;
}
</style>
{% endblock %}
