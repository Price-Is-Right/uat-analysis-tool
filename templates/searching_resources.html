{% extends "base.html" %}

{% block title %}Searching Resources - Issue Tracker{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-search me-2"></i>Searching for Helpful Resources</h4>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        We're searching multiple sources to find documentation, alternatives, and guidance that may help resolve your issue.
                    </p>
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Search Progress</h5>
                    
                    <div class="progress-steps">
                        <!-- Step 1: Microsoft Learn (all categories) -->
                        <div class="step-item" id="step-learn">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3" role="status" id="spinner-learn">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-learn"></i>
                                <div>
                                    <strong>1. Searching Microsoft Learn Documentation</strong>
                                    <div class="small text-muted">Finding relevant articles, tutorials, and guides</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-learn" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        {% if category == 'feature_request' %}
                        <!-- Step 2: TFT Features (feature_request only) -->
                        <div class="step-item" id="step-features">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-features">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-features"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-features"></i>
                                <div>
                                    <strong>2. Searching for Existing Features</strong>
                                    <div class="small text-muted">Looking for similar feature requests in Technical Feedback</div>
                                    <div class="small text-muted fst-italic mt-1">If prompted, please authenticate to access Technical Feedback...</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-features" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        {% elif category not in ['technical_support', 'cost_billing', 'aoai_capacity', 'capacity'] %}
                        <!-- Step 2: Similar Products (other categories) -->
                        <div class="step-item" id="step-products">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-products">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-products"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-products"></i>
                                <div>
                                    <strong>2. Finding Similar Products & Alternatives</strong>
                                    <div class="small text-muted">Identifying alternative Azure services that might help</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-products" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 3: Regional Availability (other categories) -->
                        <div class="step-item" id="step-regions">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-regions">
                                    <span class="visually-hidden">Searching...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-regions"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-regions"></i>
                                <div>
                                    <strong>3. Checking Regional Availability</strong>
                                    <div class="small text-muted">Finding regions where services are available</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-regions" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Step 4: Special Guidance (other categories) -->
                        <div class="step-item" id="step-guidance">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-guidance">
                                    <span class="visually-hidden">Checking...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-guidance"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-guidance"></i>
                                <div>
                                    <strong>4. Checking for Capacity & Retirement Guidance</strong>
                                    <div class="small text-muted">Looking for specific guidance related to your issue type</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-guidance" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Final Step: Preparing Results (all categories) -->
                        <div class="step-item" id="step-finalize">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3 d-none" role="status" id="spinner-finalize">
                                    <span class="visually-hidden">Finalizing...</span>
                                </div>
                                <i class="fas fa-check-circle text-success me-3 d-none" id="check-finalize"></i>
                                <i class="fas fa-circle text-muted me-3" id="wait-finalize"></i>
                                <div>
                                    <strong>{% if category == 'feature_request' %}3{% elif category in ['technical_support', 'cost_billing', 'aoai_capacity', 'capacity'] %}2{% else %}5{% endif %}. Preparing Results</strong>
                                    <div class="small text-muted">Organizing findings for your review</div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 4px;">
                                <div class="progress-bar" id="progress-finalize" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    {% if deep_search %}
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Deep Search Mode:</strong> Performing comprehensive search across all sources. This may take a bit longer but will provide more thorough results.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel Search
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 
    =============================================================================
    LOADING OVERLAY - Displayed During Backend Processing
    =============================================================================
    This semi-transparent overlay appears after 1 second if the search hasn't
    completed. This covers authentication delays and long-running backend 
    operations (embeddings, TFT searches, etc.) to prevent the appearance of
    a frozen/broken page.
    =============================================================================
-->
<div class="loading-overlay" id="finalizingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="text-light">Finalizing Results...</h4>
        <p class="text-light">Compiling search results and preparing your recommendations</p>
    </div>
</div>

<!-- 
    =============================================================================
    PROGRESS ANIMATION & SEARCH COORDINATION SCRIPT
    =============================================================================
    This script manages:
    1. Visual progress bar animations (client-side, for UX feedback)
    2. Actual background search execution (server-side via fetch)
    3. Loading overlay display (handles auth delays and long processing)
    4. Automatic redirect when search completes
    =============================================================================
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const category = '{{ category }}';
    let steps = [];
    
    // Define animation steps based on category type
    if (category === 'feature_request') {
        steps = ['learn', 'features', 'finalize'];
    } else if (['technical_support', 'cost_billing', 'aoai_capacity', 'capacity'].includes(category)) {
        steps = ['learn', 'finalize'];
    } else {
        steps = ['learn', 'products', 'regions', 'guidance', 'finalize'];
    }
    
    let currentStep = 0;
    const evalId = '{{ eval_id }}';
    const deepSearch = {{ 'true' if deep_search else 'false' }};
    
    function updateStep(stepName, status) {
        const spinner = document.getElementById('spinner-' + stepName);
        const check = document.getElementById('check-' + stepName);
        const wait = document.getElementById('wait-' + stepName);
        const progress = document.getElementById('progress-' + stepName);
        
        if (!progress) return; // Skip if step doesn't exist
        
        if (status === 'active') {
            if (wait) wait.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
            if (progress) {
                progress.style.width = '50%';
                progress.classList.add('progress-bar-animated');
            }
        } else if (status === 'complete') {
            if (spinner) spinner.classList.add('d-none');
            if (check) check.classList.remove('d-none');
            if (progress) {
                progress.style.width = '100%';
                progress.classList.remove('progress-bar-animated');
                progress.classList.add('bg-success');
            }
        }
    }
    
    let searchCompleted = false;
    let fetchStarted = false;
    
    // =========================================================================
    // EARLY OVERLAY DISPLAY
    // =========================================================================
    // Show overlay after 1 second if search hasn't completed.
    // This ensures users see feedback during:
    // - Authentication popup delays
    // - Long-running backend operations (embeddings, WIQL queries)
    // - Network delays
    // =========================================================================
    setTimeout(() => {
        if (!searchCompleted) {
            console.log('Showing overlay after 1 second - search still in progress');
            const overlay = document.getElementById('finalizingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                console.log('Overlay display set to flex');
            } else {
                console.error('Could not find overlay element!');
            }
        }
    }, 1000);
    
    // =========================================================================
    // BACKGROUND SEARCH EXECUTION
    // =========================================================================
    // Initiates server-side search immediately. This runs in parallel with
    // the client-side progress animations.
    // =========================================================================
    console.log('Starting background search...');
    fetch('/perform_search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            eval_id: evalId,
            deep_search: deepSearch
        })
    })
    .then(response => {
        console.log('Search response received, processing...');
        return response.json();
    })
    .then(data => {
        searchCompleted = true;
        console.log('Search completed, setting flag to true');
        if (data.success) {
            console.log('Search completed successfully');
        } else {
            console.error('Search failed:', data.error);
        }
    })
    .catch(error => {
        searchCompleted = true; // Mark complete even on error to prevent infinite loop
        console.error('Search error:', error);
    });
    
    function processSteps() {
        if (currentStep < steps.length) {
            updateStep(steps[currentStep], 'active');
            
            // Simulate step completion with realistic timing
            const stepDuration = deepSearch ? 1500 : 1000;
            setTimeout(() => {
                updateStep(steps[currentStep], 'complete');
                currentStep++;
                processSteps();
            }, stepDuration);
        } else {
            // All animation steps complete, wait for actual search to finish
            checkAndRedirect();
        }
    }
    
    function checkAndRedirect() {
        if (searchCompleted) {
            // Search is done, redirect immediately
            console.log('Search completed, redirecting to results');
            window.location.href = '/search_results?eval_id=' + evalId;
        } else {
            // Keep waiting and checking
            console.log('Still waiting for search to complete...');
            setTimeout(checkAndRedirect, 500);
        }
    }
    
    // Start processing animation
    setTimeout(processSteps, 500);
});
</script>

<style>
.progress-steps {
    max-width: 800px;
    margin: 0 auto;
}

.step-item {
    padding: 15px;
    border-left: 3px solid #e9ecef;
    margin-left: 20px;
}

.step-item:last-child {
    border-left-color: transparent;
}

.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Loading Overlay for final processing */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-content {
    text-align: center;
    padding: 30px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
}
</style>
{% endblock %}
