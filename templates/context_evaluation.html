{% extends "base.html" %}

{% block title %}Context Analysis Evaluation{% endblock %}

<!-- Cache buster: {{ cache_buster }} - UPDATED 2024-12-03 -->

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">üß† Intelligent Context Analysis - Please Review</h2>
            
            <div class="alert alert-info">
                <strong>Please review the system's analysis below.</strong> Your feedback helps improve the matching accuracy over time.
            </div>

            {% if is_reanalyzed %}
            <div class="alert alert-success">
                <strong>üîÑ Updated Analysis:</strong> This analysis has been updated based on your corrections. 
                {% if corrections_applied %}
                Previous corrections: 
                {% if corrections_applied.correct_category %}<span class="badge bg-primary me-1">Category: {{ corrections_applied.correct_category }}</span>{% endif %}
                {% if corrections_applied.correct_intent %}<span class="badge bg-info me-1">Intent: {{ corrections_applied.correct_intent }}</span>{% endif %}
                {% if corrections_applied.correct_business_impact %}<span class="badge bg-warning me-1">Impact: {{ corrections_applied.correct_business_impact }}</span>{% endif %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Original Issue Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìã Original Issue</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h6><strong>Title:</strong></h6>
                            <p class="text-muted">{{ original_title }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <h6><strong>Description:</strong></h6>
                            <p class="text-muted">{{ original_description }}</p>
                        </div>
                        <div class="col-md-4">
                            <h6><strong>Impact:</strong></h6>
                            <p class="text-muted">{{ original_impact }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System's Analysis Results -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ü§ñ System's Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6><strong>Category:</strong></h6>
                            <span class="badge bg-primary fs-6">{{ context.category|default('Not Available')|replace('_', ' ')|title }}</span>
                        </div>
                        <div class="col-md-3">
                            <h6><strong>Intent:</strong></h6>
                            <span class="badge bg-info fs-6">{{ context.intent|default('Not Available')|replace('_', ' ')|title }}</span>
                        </div>
                        <div class="col-md-3">
                            <h6><strong>Business Impact:</strong></h6>
                            <span class="badge bg-{% if context.business_impact == 'high' %}danger{% elif context.business_impact == 'medium' %}warning{% else %}secondary{% endif %} fs-6">
                                {{ context.business_impact|default('Not Available')|title }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <h6><strong>Confidence:</strong></h6>
                            <span class="badge {% if context.confidence and context.confidence > 0.7 %}bg-success{% elif context.confidence and context.confidence > 0.4 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                {% if context.confidence %}{{ "%.0f"|format(context.confidence * 100) }}%{% else %}N/A{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h6><strong>Context Summary:</strong></h6>
                            <div class="alert alert-light border-start border-4 border-primary">
                                <p class="mb-0">{{ context.context_summary }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comprehensive AI Reasoning Section -->
                    {% if context.reasoning %}
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6><strong>üß† Comprehensive AI Analysis & Reasoning:</strong></h6>
                            
                            <!-- Step-by-Step Analysis -->
                            <div class="card border-info mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üìã Step-by-Step Analysis Process</h6>
                                </div>
                                <div class="card-body">
                                    {% if context.reasoning.step_by_step %}
                                        <ol class="mb-0">
                                            {% for step in context.reasoning.step_by_step %}
                                            <li class="mb-1">{{ step }}</li>
                                            {% endfor %}
                                        </ol>
                                    {% else %}
                                        <em>No step-by-step analysis available</em>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Data Sources Consulted -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-success mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">‚úÖ Data Sources Used</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if context.reasoning.data_sources_used %}
                                                {% for source in context.reasoning.data_sources_used %}
                                                <div class="mb-2 p-2 border-start border-3 border-success bg-light">
                                                    <strong>{{ source.source }}</strong><br>
                                                    <small class="text-muted">{{ source.reason }}</small>
                                                    {% if source.matches_found %}
                                                    <br><small class="text-info">Matches: {{ source.matches_found|join(', ') }}</small>
                                                    {% endif %}
                                                    {% if source.data_size %}
                                                    <br><small class="text-secondary">{{ source.data_size }}</small>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <em class="text-muted">No external data sources were used</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-warning mb-3">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">‚ö†Ô∏è Data Sources Skipped</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if context.reasoning.data_sources_skipped %}
                                                {% for source in context.reasoning.data_sources_skipped %}
                                                <div class="mb-2 p-2 border-start border-3 border-warning bg-light">
                                                    <strong>{{ source.source }}</strong><br>
                                                    <small class="text-muted">{{ source.reason }}</small>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <em class="text-muted">All available data sources were consulted</em>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Microsoft Products Detected -->
                            {% if context.reasoning.microsoft_products %}
                            <div class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">üè¢ Microsoft Products Detected</h6>
                                </div>
                                <div class="card-body">
                                    {% for product in context.reasoning.microsoft_products %}
                                    <div class="mb-2 p-2 border-start border-3 border-primary bg-light">
                                        <strong>{{ product.title }}</strong><br>
                                        <small class="text-muted">{{ product.description[:150] }}{% if product.description|length > 150 %}...{% endif %}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Corrections Applied -->
                            {% if context.reasoning.corrections_applied %}
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">üéØ Corrective Learning Applied</h6>
                                </div>
                                <div class="card-body">
                                    {% for correction in context.reasoning.corrections_applied %}
                                    <div class="mb-2 p-2 border-start border-3 border-info bg-light">
                                        <strong>Pattern:</strong> {{ correction.pattern }}<br>
                                        <small class="text-muted">{{ correction.original_category }} ‚Üí {{ correction.corrected_category }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Final Analysis Summary -->
                            <div class="card border-dark">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">üéØ Final Decision Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% if context.reasoning.final_analysis %}
                                        <div class="mb-2">
                                            <strong>Category Decision:</strong>
                                            <span class="text-muted">{{ context.reasoning.final_analysis.category_reason }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Intent Decision:</strong>
                                            <span class="text-muted">{{ context.reasoning.final_analysis.intent_reason }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Data Sources:</strong>
                                            <span class="text-muted">{{ context.reasoning.final_analysis.data_source_summary }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if context.reasoning.decision_factors %}
                                        <div class="mt-3">
                                            <strong>Key Decision Factors:</strong>
                                            <ul class="mb-0 mt-1">
                                                {% for factor in context.reasoning.decision_factors %}
                                                <li>{{ factor }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    
                                    {% if context.reasoning.confidence_breakdown %}
                                        <div class="mt-3">
                                            <strong>Confidence Breakdown:</strong>
                                            <ul class="mb-0 mt-1">
                                                {% for confidence in context.reasoning.confidence_breakdown %}
                                                <li class="text-muted">{{ confidence }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Additional Context Details -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><strong>Technical Complexity:</strong></h6>
                            <span class="badge bg-{% if context.technical_complexity == 'high' %}danger{% elif context.technical_complexity == 'medium' %}warning{% else %}success{% endif %}">{{ context.technical_complexity|default('Not Available')|title }}</span>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>Urgency Level:</strong></h6>
                            <span class="badge bg-{% if context.urgency_level == 'high' %}danger{% elif context.urgency_level == 'medium' %}warning{% else %}secondary{% endif %}">{{ context.urgency_level|default('Not Available')|title }}</span>
                        </div>
                    </div>

                    <!-- Key Concepts and Keywords -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><strong>Key Concepts Identified:</strong></h6>
                            <div class="d-flex flex-wrap">
                                {% for concept in context.key_concepts[:10] %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ concept }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>Semantic Keywords:</strong></h6>
                            <div class="d-flex flex-wrap">
                                {% for keyword in context.semantic_keywords[:8] %}
                                    <span class="badge bg-info me-1 mb-1">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Domain Entities (Detailed Breakdown) -->
                    {% if context.domain_entities %}
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6><strong>Domain Entities Detected:</strong></h6>
                            <div class="accordion" id="entitiesAccordion">
                                {% for category, entities in context.domain_entities.items() %}
                                    {% if entities %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                                <strong>{{ category|replace('_', ' ')|title }}</strong> <span class="badge bg-secondary ms-2">{{ entities|length }}</span>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#entitiesAccordion">
                                            <div class="accordion-body">
                                                {% for entity in entities %}
                                                    <span class="badge bg-light text-dark border me-1 mb-1">{{ entity }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Search Strategy -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h6><strong>Recommended Search Strategy:</strong></h6>
                            <div class="row">
                                {% for key, value in search_strategy.items() %}
                                    <div class="col-md-6 mb-2">
                                        <i class="fas fa-{% if value %}check text-success{% else %}times text-muted{% endif %} me-2"></i>
                                        <span class="{% if value %}text-success fw-bold{% else %}text-muted{% endif %}">
                                            {{ key.replace('_', ' ').title() }}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Reasoning Section - Enhanced Step-by-Step Display -->
            {% if context.reasoning and context.reasoning.step_by_step %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üß† Analysis Reasoning</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-light">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            This section explains how the intelligent analysis system arrived at its conclusions to help you understand and validate the results.
                        </small>
                    </div>
                    
                    <!-- Step-by-Step Analysis Process -->
                    <h6 class="mb-3"><strong><i class="fas fa-list-ol text-primary me-2"></i>Step-by-Step Analysis Process:</strong></h6>
                    <div class="card border-primary mb-4">
                        <div class="card-body">
                            <div class="analysis-steps">
                                {% for step in context.reasoning.step_by_step %}
                                <div class="mb-2">
                                    <small class="text-muted">{{ step }}</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Final Analysis Summary -->
                    {% if context.reasoning.final_analysis %}
                    <h6 class="mb-3"><strong><i class="fas fa-check-circle text-success me-2"></i>Final Analysis Summary:</strong></h6>
                    <div class="row mb-3">
                        {% if context.reasoning.final_analysis.category_reason %}
                        <div class="col-md-12 mb-2">
                            <div class="card border-success">
                                <div class="card-body py-2">
                                    <strong>Category Decision:</strong> <small class="text-muted">{{ context.reasoning.final_analysis.category_reason }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if context.reasoning.final_analysis.intent_reason %}
                        <div class="col-md-12 mb-2">
                            <div class="card border-info">
                                <div class="card-body py-2">
                                    <strong>Intent Analysis:</strong> <small class="text-muted">{{ context.reasoning.final_analysis.intent_reason }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if context.reasoning.final_analysis.data_source_summary %}
                        <div class="col-md-12">
                            <div class="card border-secondary">
                                <div class="card-body py-2">
                                    <strong>Data Sources:</strong> <small class="text-muted">{{ context.reasoning.final_analysis.data_source_summary }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Decision Factors -->
                    {% if context.reasoning.decision_factors and context.reasoning.decision_factors|length > 0 %}
                    <h6 class="mb-3"><strong><i class="fas fa-lightbulb text-warning me-2"></i>Key Decision Factors:</strong></h6>
                    <div class="card border-warning mb-3">
                        <div class="card-body">
                            {% for factor in context.reasoning.decision_factors %}
                            <div class="mb-1">
                                <small class="text-muted">{{ factor }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Evaluation Form -->
            <form method="POST" action="{{ url_for('evaluate_context') }}">
                <input type="hidden" name="evaluation_id" value="{{ evaluation_id }}">
                
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">‚úÖ Your Evaluation</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="font-weight-bold">Is this analysis correct?</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="evaluation_result" id="approve" value="approve" onclick="toggleCorrectionFields(false)">
                                <label class="form-check-label text-success font-weight-bold" for="approve">
                                    ‚úÖ Yes, this analysis is correct - proceed with matching
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="evaluation_result" id="reject" value="reject" onclick="toggleCorrectionFields(true)">
                                <label class="form-check-label text-danger font-weight-bold" for="reject">
                                    ‚ùå No, this analysis needs correction
                                </label>
                            </div>
                        </div>

                        <!-- Search Strategy Override (shown only if approved) -->
                        <div id="strategyOverride" style="display: none;">
                            <hr>
                            <h6 class="text-info">üîß Search Strategy Options:</h6>
                            
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    {% if search_strategy.get('search_retirements') %}
                                    üîÑ The system recommends searching retirement databases first. Do you agree?
                                    {% else %}
                                    üîÑ Should we prioritize retirement database searches?
                                    {% endif %}
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="override_search_retirements" id="keep_retirement_true" value="true" 
                                           {% if search_strategy.get('search_retirements') %}checked{% endif %}>
                                    <label class="form-check-label text-success" for="keep_retirement_true">
                                        ‚úÖ Yes, search retirements first (recommended for service retirement issues)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="override_search_retirements" id="keep_retirement_false" value="false" 
                                           {% if not search_strategy.get('search_retirements') %}checked{% endif %}>
                                    <label class="form-check-label text-primary" for="keep_retirement_false">
                                        üöÄ No, skip retirements - search UATs and features directly (faster)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Correction Fields (shown only if rejected) -->
                        <div id="correctionFields" style="display: none;">
                            <hr>
                            <h6 class="text-primary">Please provide the correct analysis:</h6>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="correct_category">Correct Category:</label>
                                        <select class="form-control" name="correct_category" id="correct_category">
                                            <option value="">-- Select Category --</option>
                                            <!-- CORE CATEGORIES -->
                                            <option value="technical_support">Technical Support</option>
                                            <option value="feature_request">Feature Request</option>
                                            <option value="compliance_regulatory">Compliance/Regulatory</option>
                                            <option value="security_governance">Security/Governance</option>
                                            
                                            <!-- SERVICE CATEGORIES -->
                                            <option value="service_availability">Service Availability</option>
                                            <option value="service_retirement">Service Retirement</option>
                                            <option value="retirements">üÜï Retirements</option>
                                            
                                            <!-- CAPACITY CATEGORIES -->
                                            <option value="aoai_capacity">üÜï AOAI Capacity</option>
                                            <option value="capacity">üÜï Capacity</option>
                                            
                                            <!-- BUSINESS CATEGORIES -->
                                            <option value="business_desk">üÜï Business Desk</option>
                                            <option value="roadmap">üÜï Roadmap</option>
                                            <option value="product_roadmap">Product Roadmap</option>
                                            
                                            <!-- SUPPORT CATEGORIES -->
                                            <option value="support">üÜï Support</option>
                                            <option value="support_escalation">üÜï Support Escalation</option>
                                            
                                            <!-- SPECIALIZED CATEGORIES -->
                                            <option value="data_sovereignty">Data Sovereignty</option>
                                            <option value="sustainability">üÜï Sustainability</option>
                                            <option value="migration_modernization">Migration/Modernization</option>
                                            <option value="performance_optimization">Performance Issue</option>
                                            <option value="integration_connectivity">Integration Issue</option>
                                            <option value="cost_billing">Cost/Billing</option>
                                            <option value="training_documentation">Training/Documentation</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="correct_intent">Correct Intent:</label>
                                        <select class="form-control" name="correct_intent" id="correct_intent">
                                            <option value="">-- Select Intent --</option>
                                            <!-- SUPPORT INTENTS -->
                                            <option value="seeking_guidance">Seeking Guidance</option>
                                            <option value="reporting_issue">Reporting Issue</option>
                                            <option value="troubleshooting">Troubleshooting</option>
                                            <option value="configuration_help">Configuration Help</option>
                                            
                                            <!-- REQUEST INTENTS -->
                                            <option value="requesting_feature">Requesting Feature</option>
                                            <option value="requesting_service">Requesting Service</option>
                                            <option value="capacity_request">üÜï Capacity Request</option>
                                            
                                            <!-- BUSINESS INTENTS -->
                                            <option value="business_engagement">üÜï Business Engagement</option>
                                            <option value="escalation_request">üÜï Escalation Request</option>
                                            
                                            <!-- SPECIALIZED INTENTS -->
                                            <option value="compliance_support">Compliance Support</option>
                                            <option value="sovereignty_concern">Sovereignty Concern</option>
                                            <option value="roadmap_inquiry">Roadmap Inquiry</option>
                                            <option value="sustainability_inquiry">üÜï Sustainability Inquiry</option>
                                            <option value="need_migration_help">Migration Help</option>
                                            <option value="best_practices">Best Practices</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="correct_business_impact">Correct Business Impact:</label>
                                        <select class="form-control" name="correct_business_impact" id="correct_business_impact">
                                            <option value="">-- Select Impact --</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="correction_notes">Additional Notes/Explanation:</label>
                                <textarea class="form-control" name="correction_notes" id="correction_notes" rows="3" 
                                          placeholder="Please explain why the system's analysis was incorrect and provide any additional context..."></textarea>
                            </div>
                        </div>

                        <!-- Feedback (always shown) -->
                        <div class="form-group mt-3">
                            <label for="general_feedback">General Feedback (optional):</label>
                            <textarea class="form-control" name="general_feedback" id="general_feedback" rows="2" 
                                      placeholder="Any additional feedback to help improve the system..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <!-- Show different buttons based on evaluation choice -->
                    <div id="approveButtons" style="display: none; margin-bottom: 30px;">
                        <button type="submit" class="btn btn-success" name="action" value="approve" style="margin: 10px;">
                            <i class="fas fa-check"></i> Approve & Create UAT
                        </button>
                    </div>
                    
                    <div id="correctButtons" style="display: none; margin-bottom: 30px;">
                        <div style="margin-bottom: 15px;">
                            <button type="submit" class="btn btn-primary" name="action" value="reanalyze" style="margin: 5px; display: block; width: 250px; margin-left: auto; margin-right: auto;">
                                <i class="fas fa-sync-alt"></i> Reanalyze with Corrections
                            </button>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-warning" name="action" value="save_corrections" style="margin: 5px; display: block; width: 250px; margin-left: auto; margin-right: auto;">
                                <i class="fas fa-save"></i> Save Corrections Only
                            </button>
                        </div>
                    </div>
                    
                    <!-- Default state -->
                    <div id="defaultButtons" style="margin-bottom: 30px;">
                        <button type="submit" class="btn btn-secondary" disabled>
                            <i class="fas fa-question"></i> Please select an option above
                        </button>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleCorrectionFields(show) {
    console.log('toggleCorrectionFields called with:', show);
    
    const correctionDiv = document.getElementById('correctionFields');
    const strategyDiv = document.getElementById('strategyOverride');
    const approveButtons = document.getElementById('approveButtons');
    const correctButtons = document.getElementById('correctButtons');
    const defaultButtons = document.getElementById('defaultButtons');
    
    console.log('Elements found:', {
        correctionDiv: !!correctionDiv,
        strategyDiv: !!strategyDiv,
        approveButtons: !!approveButtons,
        correctButtons: !!correctButtons,
        defaultButtons: !!defaultButtons
    });
    
    if (show) {
        // Show correction fields and correction buttons
        if (correctionDiv) correctionDiv.style.display = 'block';
        if (strategyDiv) strategyDiv.style.display = 'none';
        if (approveButtons) approveButtons.style.display = 'none';
        if (correctButtons) {
            correctButtons.style.display = 'block';
            console.log('Set correctButtons to display: block');
        }
        if (defaultButtons) defaultButtons.style.display = 'none';
        // Make correction fields required
        document.getElementById('correct_category').required = true;
        document.getElementById('correct_intent').required = true;
        document.getElementById('correct_business_impact').required = true;
    } else {
        // Show approval flow
        if (correctionDiv) correctionDiv.style.display = 'none';
        if (strategyDiv) strategyDiv.style.display = 'block';
        if (approveButtons) {
            approveButtons.style.display = 'block';
            console.log('Set approveButtons to display: block');
        }
        if (correctButtons) correctButtons.style.display = 'none';
        if (defaultButtons) defaultButtons.style.display = 'none';
        // Remove required attribute
        document.getElementById('correct_category').required = false;
        document.getElementById('correct_intent').required = false;
        document.getElementById('correct_business_impact').required = false;
    }
}

// Pre-populate correction fields with system's analysis for easier correction
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing button state');
    
    // Initialize button visibility
    const defaultButtons = document.getElementById('defaultButtons');
    const approveButtons = document.getElementById('approveButtons');
    const correctButtons = document.getElementById('correctButtons');
    
    if (defaultButtons) defaultButtons.style.display = 'block';
    if (approveButtons) approveButtons.style.display = 'none';
    if (correctButtons) correctButtons.style.display = 'none';
    
    console.log('Button state initialized');
    
    // Pre-populate correction fields
    document.getElementById('correct_category').value = '{{ context.category }}';
    document.getElementById('correct_intent').value = '{{ context.intent }}';
    document.getElementById('correct_business_impact').value = '{{ context.business_impact }}';
});
</script>

<style>
.badge-lg {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}
.card-header h5 {
    margin: 0;
}
.form-check-label {
    font-size: 1.1em;
}

/* Better button spacing to prevent overlap - Updated 2024-12-03 */
#correctButtons, #approveButtons, #defaultButtons {
    margin-bottom: 40px !important;
    clear: both !important;
    overflow: hidden !important;
}

#correctButtons button, #approveButtons button, #defaultButtons button {
    margin: 15px 10px !important;
    white-space: nowrap !important;
    min-width: 220px !important;
    display: block !important;
    margin-left: auto !important;
    margin-right: auto !important;
}

#correctButtons div {
    margin-bottom: 20px !important;
}

/* Force vertical stacking for correction buttons */
#correctButtons {
    display: block !important;
}

#correctButtons button {
    clear: both !important;
    float: none !important;
}

/* Ensure proper separation between action buttons and cancel */
.text-center > div:last-child {
    margin-top: 50px !important;
    padding-top: 25px !important;
    border-top: 3px solid #dee2e6 !important;
    clear: both !important;
}
</style>
{% endblock %}