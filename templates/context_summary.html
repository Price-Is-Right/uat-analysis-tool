{% extends "base.html" %}

{% block title %}Analysis Summary{% endblock %}
<!-- Override navbar to show See Detailed Analysis link -->
{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <span class="navbar-brand">
            <i class="fas fa-headset me-2"></i>Issue Tracker System
        </span>
        <div class="navbar-nav ms-auto">
            <span class="nav-link text-light">
                <i class="fas fa-brain me-1"></i>Analysis In Progress
            </span>
            <a class="nav-link" href="{{ url_for('evaluate_context', eval_id=evaluation_id) }}">
                <i class="fas fa-search-plus me-1"></i>See Detailed Analysis
            </a>
        </div>
    </div>
</nav>
{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Analysis Complete - Step 3 of 3
                    </h4>
                </div>
                <div class="card-body">
                    {% if context.ai_available and not context.ai_error %}
                    <div class="alert alert-success border-start border-4 border-success">
                        <i class="fas fa-robot me-2"></i>
                        <strong>AI-Powered Analysis Complete!</strong> Your issue has been analyzed using Azure OpenAI ({{ "%.0f"|format((context.confidence or 0) * 100) }}% confidence). Please review the classification below.
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-brain me-2"></i>
                        <strong>Our AI has analyzed your submission!</strong> Please review the classification below and let us know if you agree.
                    </div>
                    {% endif %}

                    <!-- AI Service Status Alert -->
                    {% if context.ai_error %}
                    <div class="alert alert-warning border-start border-4 border-warning mb-4">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Analysis Method Notice</h6>
                        <p class="mb-2">
                            <strong>AI service temporarily unavailable.</strong> We've used our pattern-matching system instead, which provides reliable results but may have lower confidence.
                        </p>
                        <small class="text-muted">Pattern matching confidence: {{ "%.0f"|format((context.pattern_confidence or context.confidence or 0) * 100) }}%</small>
                    </div>
                    {% elif not context.ai_available %}
                    <div class="alert alert-secondary mb-4">
                        <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Pattern-Based Analysis</h6>
                        <p class="mb-2">
                            AI services are not configured. Using pattern-matching system ({{ "%.0f"|format((context.confidence or 0) * 100) }}% confidence).
                        </p>
                        <small class="text-muted"><strong>Note:</strong> AI requires Azure OpenAI configuration. Pattern matching provides reliable results using rule-based classification.</small>
                    </div>
                    {% endif %}

                    <!-- Original Issue Summary -->
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Your Submission</h6>
                        </div>
                        <div class="card-body">
                            <h5 class="text-primary">{{ original_title }}</h5>
                            <p class="text-muted mb-2">{{ original_description[:200] }}{% if original_description|length > 200 %}...{% endif %}</p>
                            {% if original_impact %}
                            <p class="mb-0"><strong>Impact:</strong> {{ original_impact[:150] }}{% if original_impact|length > 150 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Classification Results -->
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Classification</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-md-4">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted">Category</h6>
                                        <span class="badge bg-primary fs-5">{{ context.category|default('Not Available')|replace('_', ' ')|title }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted">Intent</h6>
                                        <span class="badge bg-info fs-5">{{ context.intent|default('Not Available')|replace('_', ' ')|title }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted">Confidence</h6>
                                        <span class="badge bg-{% if context.confidence >= 0.8 %}success{% elif context.confidence >= 0.6 %}warning{% else %}secondary{% endif %} fs-5">
                                            {{ "%.0f"|format((context.confidence or 0) * 100) }}%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="row text-center">
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted">Business Impact</h6>
                                        <span class="badge bg-{% if context.business_impact == 'high' %}danger{% elif context.business_impact == 'medium' %}warning{% else %}secondary{% endif %} fs-5">
                                            {{ context.business_impact|default('Not Available')|title }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted">Technical Complexity</h6>
                                        <span class="badge bg-{% if context.technical_complexity == 'high' %}danger{% elif context.technical_complexity == 'medium' %}warning{% else %}success{% endif %} fs-5">
                                            {{ context.technical_complexity|default('Not Available')|title }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {% if context.reasoning %}
                            <div class="mt-3 p-3 bg-light rounded">
                                <h6><i class="fas fa-comment-dots me-2"></i>Why we classified it this way:</h6>
                                {% if context.reasoning is string %}
                                    <p class="mb-0 text-muted">{{ context.reasoning }}</p>
                                {% elif context.reasoning is mapping %}
                                    <p class="mb-0 text-muted">
                                        {% if context.reasoning.get('summary') %}
                                            {{ context.reasoning.summary }}
                                        {% elif context.context_summary %}
                                            {{ context.context_summary }}
                                        {% else %}
                                            Based on the analysis, we identified this as a {{ context.category|replace('_', ' ')|title }} with intent to {{ context.intent|replace('_', ' ')|title }}.
                                            {% if context.reasoning.get('confidence_factors') %}
                                                Key factors include: {{ context.reasoning.confidence_factors|join(', ') }}.
                                            {% endif %}
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- User Feedback Section -->
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Does this look correct?</h5>
                        </div>
                        <div class="card-body">
                            <p>Please review the classification above. Your feedback helps our AI learn and improve!</p>
                            
                            <form method="POST" action="{{ url_for('submit_evaluation_summary') }}">
                                <input type="hidden" name="evaluation_id" value="{{ evaluation_id }}">
                                
                                <div class="d-grid gap-3">
                                    <!-- Agree and Continue -->
                                    <button type="submit" name="action" value="agree" class="btn btn-success btn-lg">
                                        <i class="fas fa-thumbs-up me-2"></i>Looks Good - Continue to Search Results
                                    </button>

                                    <!-- Modify Classification -->
                                    <button type="submit" name="action" value="modify" class="btn btn-warning btn-lg">
                                        <i class="fas fa-edit me-2"></i>Modify Classification
                                    </button>

                                    <!-- Cancel -->
                                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
