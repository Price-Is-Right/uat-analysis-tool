<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Related UATs - Issue Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .uat-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }
        .uat-checkbox:checked {
            background-color: #0078d4;
            border-color: #0078d4;
        }
        .hover-highlight:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .selection-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-search me-2"></i>Select Related UATs
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Info Alert -->
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Similar UATs Found!</strong> We found existing UATs that may be related to your issue.
                            <strong>Please select any UATs that are the same or similar in nature</strong> (maximum 5).
                            This helps track related issues and provides better context for your UAT.
                        </div>

                        <!-- Current Issue Display -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Your Issue:</label>
                            <div class="p-3 bg-light rounded">
                                {{ wizard_title }}
                            </div>
                        </div>

                        <!-- Similar UATs List -->
                        <div class="card mb-4">
                            <div class="card-header" style="background-color: #0078d4; color: white;">
                                <h5 class="mb-0">
                                    <i class="fas fa-link me-2"></i>Similar UATs Found (Last 180 Days)
                                    <span class="badge bg-light text-dark ms-2">{{ found_uats|length }}</span>
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <p class="text-muted mb-3">
                                    <i class="fas fa-check-circle me-1"></i>
                                    <strong>Select up to 5 UATs</strong> that are related to your issue. Selected UATs will be referenced in your new UAT submission.
                                </p>
                                <div class="list-group">
                                    {% for uat in found_uats %}
                                    <div class="list-group-item hover-highlight">
                                        <div class="d-flex align-items-start">
                                            <input type="checkbox" 
                                                   class="form-check-input mt-1 me-3 uat-checkbox" 
                                                   id="uat-{{ uat.id }}"
                                                   data-uat-id="{{ uat.id }}"
                                                   data-uat-title="{{ uat.title }}"
                                                   data-uat-url="{{ uat.url }}"
                                                   {% if uat.id|string in selected_uats %}checked{% endif %}>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="mb-1">
                                                        <label for="uat-{{ uat.id }}" style="cursor: pointer;">
                                                            <span class="badge bg-secondary me-2">#{{ uat.id }}</span>
                                                            {{ uat.title }}
                                                        </label>
                                                    </h6>
                                                    {% if uat.similarity %}
                                                    <span class="badge bg-success">{{ (uat.similarity * 100)|int }}% match</span>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if uat.description %}
                                                <p class="mb-2 small text-muted">{{ uat.description[:250] }}{% if uat.description|length > 250 %}...{% endif %}</p>
                                                {% endif %}
                                                
                                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>Created: {{ uat.created_date[:10] if uat.created_date else 'N/A' }}
                                                        <span class="ms-3">
                                                            <i class="fas fa-tag me-1"></i>
                                                            <span class="badge {% if uat.state == 'Active' %}bg-primary{% elif uat.state == 'Resolved' %}bg-success{% elif uat.state == 'Closed' %}bg-secondary{% else %}bg-info{% endif %}">
                                                                {{ uat.state }}
                                                            </span>
                                                        </span>
                                                        {% if uat.assigned_to %}
                                                        <span class="ms-3">
                                                            <i class="fas fa-user me-1"></i>{{ uat.assigned_to }}
                                                        </span>
                                                        {% endif %}
                                                    </small>
                                                    <a href="{{ uat.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt me-1"></i>View in ADO
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between gap-3 mt-4">
                            <a href="{{ url_for('uat_input') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </a>
                            <button type="button" class="btn btn-success btn-lg" id="continueBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Create UAT
                                <span class="badge bg-light text-dark ms-2" id="selectedCount">0 selected</span>
                            </button>
                        </div>

                        <!-- Help Text -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="mb-2"><i class="fas fa-question-circle me-2"></i>Why select related UATs?</h6>
                            <ul class="mb-0 small">
                                <li>Helps identify duplicate or related issues</li>
                                <li>Provides better context for the support team</li>
                                <li>Enables tracking of related customer scenarios</li>
                                <li>Improves overall issue resolution efficiency</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection Counter (Fixed Position) -->
    <div class="selection-counter d-none">
        <div class="card shadow-lg">
            <div class="card-body p-3">
                <strong><i class="fas fa-check-circle text-success me-2"></i><span id="counterText">0 UATs selected</span></strong>
                <small class="d-block text-muted mt-1">Maximum 5 allowed</small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Track selected UAT count
        let selectedCount = {{ selected_uats|length }};
        const maxSelections = 5;

        // Update the counter display
        function updateCounter() {
            const countBadge = document.getElementById('selectedCount');
            const counterText = document.getElementById('counterText');
            const selectionCounter = document.querySelector('.selection-counter');
            
            countBadge.textContent = `${selectedCount} selected`;
            counterText.textContent = `${selectedCount} UAT${selectedCount !== 1 ? 's' : ''} selected`;
            
            // Show/hide floating counter
            if (selectedCount > 0) {
                selectionCounter.classList.remove('d-none');
            } else {
                selectionCounter.classList.add('d-none');
            }
        }

        // Initialize counter on page load
        updateCounter();

        // Handle UAT checkbox selection
        document.querySelectorAll('.uat-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const uatId = this.dataset.uatId;
                const isChecked = this.checked;
                
                // Check max limit before allowing selection
                if (isChecked && selectedCount >= maxSelections) {
                    this.checked = false;
                    alert(`Maximum ${maxSelections} UATs can be selected.`);
                    return;
                }
                
                // Show loading state
                const label = this.parentElement.querySelector('label');
                const originalHTML = label.innerHTML;
                
                if (isChecked) {
                    label.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Selecting...';
                } else {
                    label.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deselecting...';
                }
                
                // Save selection via AJAX
                fetch('/save_selected_uat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selection_id: '{{ selection_id }}',
                        uat_id: uatId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Restore label
                        label.innerHTML = originalHTML;
                        
                        // Update count from server response
                        selectedCount = data.count;
                        updateCounter();
                        
                        console.log(data.message);
                    } else {
                        // Revert checkbox on error
                        this.checked = !isChecked;
                        label.innerHTML = originalHTML;
                        alert(data.error || 'Failed to save selection');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.checked = !isChecked;
                    label.innerHTML = originalHTML;
                    alert('An error occurred while saving your selection');
                });
            });
        });

        // Continue button
        document.getElementById('continueBtn').addEventListener('click', function() {
            // Can proceed with or without selections
            window.location.href = "{{ url_for('create_uat') }}";
        });
    </script>
</body>
</html>
