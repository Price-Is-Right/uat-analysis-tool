{% extends "base.html" %}

{% block title %}Review Results - Issue Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h2 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>Search Results & UAT Creation
                </h2>
            </div>
            <div class="card-body">
                <!-- Show search results if any -->
                {% if enhanced_results and enhanced_results.get('total_matches', 0) > 0 %}
                <div class="alert alert-success" role="alert">
                    <h5 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>Found {{ enhanced_results.get('total_matches', 0) }} Similar Item(s)
                    </h5>
                    <p class="mb-0">
                        We found some potentially related items. Please review them below to see if any match your issue.
                        If none of these solve your problem, you can create a new UAT ticket at the bottom of this page.
                    </p>
                    <p><strong>TOTAL ITEMS IN enhanced_results.all_items:</strong> {{ enhanced_results.get('all_items', [])|length }}</p>
                </div>

                <!-- Display search results -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Similar Items Found:</h5>
                        {% if paginated_results and paginated_results['total_items'] > 0 %}
                        <div class="text-muted mb-3">
                            Showing {{ (paginated_results['page'] - 1) * paginated_results['per_page'] + 1 }} to 
                            {{ paginated_results['page'] * paginated_results['per_page'] if paginated_results['page'] * paginated_results['per_page'] <= paginated_results['total_items'] else paginated_results['total_items'] }} 
                            of {{ paginated_results['total_items'] }} results
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if paginated_results %}
                        {% for item in paginated_results['items'] %}
                        <div class="card mb-3 w-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ item.get('title', 'Untitled') }}</h6>
                                    {% if item.get('source') == 'UAT' %}
                                        <span class="badge bg-primary">UAT</span>
                                    {% elif item.get('source') == 'TFT' %}
                                        <span class="badge bg-success">TFT</span>
                                    {% else %}
                                        <span class="badge bg-info">Evaluating Retirement</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <small class="text-muted">
                                        {% if item.get('type') == 'retirement' %}
                                            {{ (item.get('match_score', 0) * 100) | round(1) }}% match
                                        {% else %}
                                            {{ (item.get('similarity', 0) * 100) | round(1) }}% match
                                        {% endif %}
                                    </small>
                                    {% if item.get('url') %}
                                    <a href="{{ item.get('url') }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2" title="View Item">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ (item.get('description', 'No description')|clean_html)[:300] }}{% if (item.get('description', '')|clean_html)|length > 300 %}...{% endif %}</p>
                            </div>
                        </div>
                    {% endfor %}
                    {% endif %}
                    
                    <!-- Pagination Controls -->
                    {% if paginated_results and paginated_results['total_pages'] > 1 %}
                    <nav aria-label="Search results pagination" class="mt-4">
                        <div class="d-flex justify-content-center">
                            <div class="btn-group" role="group">
                                {% if paginated_results['has_prev'] %}
                                <a href="{{ url_for('no_match', page=paginated_results['prev_num']) }}" class="btn btn-outline-primary">
                                    <i class="fas fa-chevron-left me-1"></i>Previous
                                </a>
                                {% else %}
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="fas fa-chevron-left me-1"></i>Previous
                                </button>
                                {% endif %}
                                
                                {% for page_num in range(1, paginated_results['total_pages'] + 1) %}
                                    {% if page_num == paginated_results['page'] %}
                                    <button class="btn btn-primary">{{ page_num }}</button>
                                    {% elif page_num == 1 or page_num == paginated_results['total_pages'] or (page_num >= paginated_results['page'] - 2 and page_num <= paginated_results['page'] + 2) %}
                                    <a href="{{ url_for('no_match', page=page_num) }}" class="btn btn-outline-primary">{{ page_num }}</a>
                                    {% elif page_num == paginated_results['page'] - 3 or page_num == paginated_results['page'] + 3 %}
                                    <button class="btn btn-outline-secondary" disabled>...</button>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if paginated_results['has_next'] %}
                                <a href="{{ url_for('no_match', page=paginated_results['next_num']) }}" class="btn btn-outline-primary">
                                    Next<i class="fas fa-chevron-right ms-1"></i>
                                </a>
                                {% else %}
                                <button class="btn btn-outline-secondary" disabled>
                                    Next<i class="fas fa-chevron-right ms-1"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </nav>
                    {% endif %}
                </div>

                <hr class="my-4">
                {% else %}
                <div class="alert alert-warning" role="alert">
                    <h5 class="alert-heading">
                        <i class="fas fa-search me-2"></i>No Similar Issues Found
                    </h5>
                    <p class="mb-0">
                        We couldn't find any existing solutions that match your specific problem. 
                        Let us help you create a support ticket to get this resolved.
                    </p>
                </div>
                {% endif %}

                <!-- Your Issue Summary -->
                <div class="mb-4">
                    <h5>Your Issue:</h5>
                    {% if wizard_title %}
                    <h6 class="text-primary mb-2">{{ wizard_title }}</h6>
                    {% endif %}
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="card-text">{{ current_issue }}</p>
                        </div>
                    </div>
                </div>

                <div class="card border-primary mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-ticket-alt me-2"></i>Create New UAT (User Action Tracker)
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>
                            Since no similar issues were found, we'll create a new User Action Tracker (UAT) ticket for your issue. 
                            This will ensure your issue gets the proper attention from our technical team.
                        </p>
                        
                        <h6>What happens next:</h6>
                        <ul>
                            <li><strong>UAT Creation:</strong> Your issue will be created as a new work item in our UAT system</li>
                            <li><strong>Technical Review:</strong> Our team will analyze and categorize your issue</li>
                            <li><strong>Progress Tracking:</strong> You'll receive updates as your issue moves through the resolution process</li>
                            <li><strong>Solution Delivery:</strong> Once resolved, the solution will be made available and documented</li>
                        </ul>
                        
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Your enhanced AI analysis and issue categorization will be included in the UAT to help our team understand and prioritize your request.
                        </div>
                        
                        <div class="alert alert-success mt-3" role="alert">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Typical Response Time:</strong> 1-2 business days for initial review and assignment
                        </div>
                    </div>
                </div>

                <form method="POST" action="{{ url_for('create_uat') }}">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Start Over
                        </a>
                        <div>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-warning me-2">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle me-1"></i>Create UAT Ticket
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}
