{% extends "base.html" %}

{% block title %}Input Quality Review{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header {{ 'bg-success text-white' if quality.completeness_score >= 80 else 'bg-info text-white' }}">
                    <h4 class="mb-0">
                        <i class="fas {{ 'fa-check-circle' if quality.completeness_score >= 80 else 'fa-eye' }} me-2"></i>Final Review & Quality Check
                    </h4>
                </div>
                <div class="card-body">
                    {% if quality.completeness_score >= 80 %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Your submission quality is good!</strong>
                            You can proceed with your current submission, or review and make any final improvements below before continuing.
                        </div>
                    {% elif quality.garbage_detected %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Invalid input detected!</strong>
                            Our system detected that some of your input appears to be random characters or meaningless text. Please provide clear, descriptive information about your issue so we can help you effectively.
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                             <i class="fas fa-info-circle me-2"></i>
                            <strong>Final review and improvement opportunity</strong>
                            Before we process your request, here's a chance to review your submission and make any improvements. Our AI analysis found some areas where additional context would help us provide better assistance.
                        </div>
                    {% endif %}
                    
                    <!-- Quality Score -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Completeness Score:</label>
                        <div class="progress quality-progress">
                            <div class="progress-bar bg-{{ 'danger' if quality.completeness_score < 50 else 'warning' if quality.completeness_score < 80 else 'success' }}" 
                                 role="progressbar" 
                                 style="width: {{ quality.completeness_score }}%"
                                 aria-label="Completeness Score {{ quality.completeness_score }}%">
                                {{ quality.completeness_score }}%
                            </div>
                        </div>
                        {% if quality.completeness_score >= 80 %}
                            <small class="text-success fw-bold">✅ Great! Your submission has enough information for our AI to provide effective assistance</small>
                        {% elif is_second_attempt and show_proceed_warning %}
                            <small class="text-warning-accessible fw-bold">⚠️ Your submission is {{ quality.completeness_score }}% complete, which is below the suggested 80%. This may hinder getting the most applicable help. You can proceed anyway or edit again.</small>
                        {% else %}
                            <small class="text-muted">We need at least 80% completeness for our AI to provide effective assistance</small>
                        {% endif %}
                    </div>

                    <!-- Current Submission -->
                    <div class="mb-4">
                        <h5 class="text-muted">
                            <i class="fas fa-file-alt me-2"></i>Your Current Submission
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Title:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ title or 'No title provided' }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ description or 'No description provided' }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Impact:</label>
                            <div class="border p-3 bg-light rounded">
                                {{ impact or 'No impact statement provided' }}
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions for Improvement -->
                    <div class="mb-4">
                        <h5 class="text-danger">
                            <i class="fas fa-lightbulb me-2"></i>Suggestions for Improvement
                        </h5>
                        
                        {% if quality.suggestions %}
                            <div class="list-group">
                                {% for suggestion in quality.suggestions %}
                                    <div class="list-group-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>{{ suggestion }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Improved Form -->
                    <div class="card bg-light">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2"></i>Please Improve Your Submission
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('submit_issue') }}">
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-bold">
                                        Title <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Be specific about your issue or request (e.g., "Login button not working on Chrome browser" or "Need additional Azure licenses for team")</small>
                                    </label>
                                    <input type="text" 
                                           class="form-control {{ 'is-invalid' if 'title' in quality.issues|join(' ') else '' }}" 
                                           id="title" 
                                           name="title" 
                                           value="{{ title }}" 
                                           maxlength="125"
                                           placeholder="Specific, descriptive title of your issue or request">
                                    <div class="form-text" id="title-counter">
                                        <i class="fas fa-keyboard me-1"></i>
                                        <span id="title-count">{{ title|length if title else 0 }}</span>/125 characters
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label fw-bold">
                                        Description <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Describe your situation, issue, or request with enough context for our AI to understand and help you effectively (minimum {{ min_words }} words)</small>
                                    </label>
                                    <textarea class="form-control {{ 'is-invalid' if 'description' in quality.issues|join(' ') else '' }}" 
                                              id="description" 
                                              name="description" 
                                              rows="4" 
                                              placeholder="Detailed description of your situation, issue, or request with sufficient context for understanding">{{ description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="impact" class="form-label fw-bold">
                                        Business Impact <span class="text-danger">*</span>
                                        <small class="text-muted d-block">Who is affected and how? Describe the consequences or benefits of resolving this</small>
                                    </label>
                                    <textarea class="form-control {{ 'is-invalid' if 'impact' in quality.issues|join(' ') else '' }}" 
                                              id="impact" 
                                              name="impact" 
                                              rows="3" 
                                              placeholder="Describe who is affected and how - include the consequences of the current situation or benefits of resolving this">{{ impact }}</textarea>
                                </div>
                                
                                <!-- Hidden fields to preserve other data -->
                                <input type="hidden" name="opportunity_id" value="{{ opportunity_id }}">
                                <input type="hidden" name="milestone_id" value="{{ milestone_id }}">
                                <input type="hidden" name="is_second_attempt" value="{{ 'true' if is_second_attempt else 'false' }}">
                                
                                <!-- Hidden field to indicate action type -->
                                <input type="hidden" name="action" value="improve" id="form-action">
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancel
                                    </a>
                                    {% if quality.completeness_score >= 80 %}
                                        <div class="btn-group">
                                            <button type="submit" class="btn btn-outline-primary">
                                                <i class="fas fa-edit me-2"></i>Make Final Improvements
                                            </button>
                                            <button type="button" class="btn btn-success" onclick="proceedWithCurrent()">
                                                <i class="fas fa-check me-2"></i>Proceed as Is
                                            </button>
                                        </div>
                                    {% elif is_second_attempt and show_proceed_warning %}
                                        <div class="btn-group">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-edit me-2"></i>Edit Again
                                            </button>
                                            <button type="button" class="btn btn-primary" onclick="proceedWithCurrent()">
                                                <i class="fas fa-exclamation-triangle me-2"></i>Proceed Anyway
                                            </button>
                                        </div>
                                    {% else %}
                                        <button type="submit" class="btn btn-primary" onclick="setSecondAttempt()">
                                            <i class="fas fa-paper-plane me-2"></i>Submit Improved Issue
                                        </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle proceed with current issue
function proceedWithCurrent() {
    // Set action to proceed and submit with original data
    document.getElementById('form-action').value = 'proceed';
    
    // Set form fields to original values to avoid quality re-check
    document.getElementById('title').value = "{{ title }}";
    document.getElementById('description').value = "{{ description|replace('\n', '\\n')|replace('\r', '') }}";
    document.getElementById('impact').value = "{{ impact|replace('\n', '\\n')|replace('\r', '') }}";
    
    // Submit the form
    document.querySelector('form').submit();
}

// Set second attempt flag when submitting improved issue
function setSecondAttempt() {
    document.querySelector('input[name="is_second_attempt"]').value = 'true';
}

// Title character counter
function updateTitleCounter() {
    const titleInput = document.getElementById('title');
    const titleCount = document.getElementById('title-count');
    const titleCounter = document.getElementById('title-counter');
    
    if (titleInput && titleCount && titleCounter) {
        const currentLength = titleInput.value.length;
        titleCount.textContent = currentLength;
        
        // Update styling based on length
        if (currentLength > 100) {
            titleCounter.className = 'form-text text-success';
        } else if (currentLength > 75) {
            titleCounter.className = 'form-text text-info';
        } else {
            titleCounter.className = 'form-text text-muted';
        }
    }
}

// Word count helpers
function updateWordCount(textareaId, minWords) {
    const textarea = document.getElementById(textareaId);
    const words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    
    let badge = document.getElementById(textareaId + '_count');
    if (!badge) {
        badge = document.createElement('small');
        badge.id = textareaId + '_count';
        badge.className = 'badge position-absolute';
        badge.style.top = '5px';
        badge.style.right = '5px';
        textarea.parentNode.style.position = 'relative';
        textarea.parentNode.appendChild(badge);
    }
    
    badge.textContent = `${words} words`;
    badge.className = `badge position-absolute ${words >= minWords ? 'bg-success' : 'bg-warning'}`;
}

// Add word counters
document.addEventListener('DOMContentLoaded', function() {
    // Initialize title counter
    const titleInput = document.getElementById('title');
    if (titleInput) {
        updateTitleCounter();
        titleInput.addEventListener('input', updateTitleCounter);
    }

    const description = document.getElementById('description');
    const impact = document.getElementById('impact');
    
    if (description) {
        updateWordCount('description', {{ min_words }});
        description.addEventListener('input', () => updateWordCount('description', {{ min_words }}));
    }
    
    if (impact) {
        updateWordCount('impact', {{ min_impact_words }});
        impact.addEventListener('input', () => updateWordCount('impact', {{ min_impact_words }}));
    }
});
</script>
{% endblock %}
