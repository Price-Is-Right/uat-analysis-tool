{% extends "base.html" %}

{% block title %}Step 5: Review Information - Issue Tracker{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Progress indicator -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Step 5 of 5</span>
                <span class="text-muted">Review & Submit</span>
            </div>
            <div class="progress">
                <div class="progress-bar bg-success progress-bar-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" title="Progress: 100%"></div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h2 class="card-title mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>Review Your Information
                </h2>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <i class="fas fa-eye fa-3x text-success mb-3"></i>
                    <h4>Please review your information</h4>
                    <p class="text-muted">
                        Make sure everything is correct, or edit any field that needs changes.
                    </p>
                </div>

                <form method="POST" action="{{ url_for('wizard.wizard_update_review') }}">
                    <div class="mb-4">
                        <label for="title" class="form-label">
                            <strong><i class="fas fa-tag me-1"></i>Issue Title</strong>
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="title" 
                            name="title" 
                            value="{{ wizard_data.title }}"
                            maxlength="125"
                            required
                        >
                    </div>

                    <div class="mb-4">
                        <label for="description" class="form-label">
                            <strong><i class="fas fa-align-left me-1"></i>Issue Description</strong>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="description" 
                            name="description" 
                            rows="5"
                            required
                        >{{ wizard_data.description }}</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="impact" class="form-label">
                            <strong><i class="fas fa-exclamation-triangle me-1"></i>Impact Assessment</strong>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="impact" 
                            name="impact" 
                            rows="3"
                            required
                        >{{ wizard_data.impact }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="opportunity_id" class="form-label">
                                    <strong><i class="fas fa-bullseye me-1"></i>Opportunity ID</strong>
                                    <span class="text-muted">(Optional)</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="opportunity_id" 
                                    name="opportunity_id" 
                                    value="{{ wizard_data.opportunity_id }}"
                                    placeholder="Optional"
                                >
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="milestone_id" class="form-label">
                                    <strong><i class="fas fa-flag-checkered me-1"></i>Milestone ID</strong>
                                    <span class="text-muted">(Optional)</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="milestone_id" 
                                    name="milestone_id" 
                                    value="{{ wizard_data.milestone_id }}"
                                    placeholder="Optional"
                                >
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{{ url_for('wizard.wizard_step', step=4) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </a>
                        <button type="submit" id="update-btn" class="btn btn-info">
                            <i class="fas fa-sync-alt me-1"></i>Update Information
                        </button>
                    </div>
                </form>

                <hr class="my-4">

                <div class="text-center">
                    <h5 class="mb-3">Is this information correct?</h5>
                    <div id="dirty-warning" class="alert alert-warning d-none mb-3" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>You have unsaved changes.</strong> Please click "Update Information" before submitting, or your changes will be lost.
                    </div>
                    <form method="POST" action="{{ url_for('submit_issue') }}" id="submitForm">
                        <!-- Hidden fields to capture current form values -->
                        <input type="hidden" name="title" id="hidden-title" value="{{ wizard_data.title }}">
                        <input type="hidden" name="description" id="hidden-description" value="{{ wizard_data.description }}">
                        <input type="hidden" name="impact" id="hidden-impact" value="{{ wizard_data.impact }}">
                        <input type="hidden" name="opportunity_id" id="hidden-opportunity-id" value="{{ wizard_data.opportunity_id }}">
                        <input type="hidden" name="milestone_id" id="hidden-milestone-id" value="{{ wizard_data.milestone_id }}">
                        <input type="hidden" name="source" value="wizard">
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-danger">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" id="submit-btn" class="btn btn-success btn-lg">
                                <i class="fas fa-search me-1"></i>Continue to Quality Review
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="mt-3 text-center">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Next: Quality review and final improvements, then we'll search for solutions
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dirty flag system
let isDirty = false;
const originalValues = {};
const submitBtn = document.getElementById('submit-btn');
const updateBtn = document.getElementById('update-btn');
const dirtyWarning = document.getElementById('dirty-warning');

// Store original values
function storeOriginalValues() {
    const fields = ['title', 'description', 'impact', 'opportunity_id', 'milestone_id'];
    fields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            originalValues[fieldId] = element.value;
        }
    });
}

// Check if form is dirty
function checkDirtyState() {
    let hasChanges = false;
    
    for (const fieldId in originalValues) {
        const element = document.getElementById(fieldId);
        if (element && element.value !== originalValues[fieldId]) {
            hasChanges = true;
            break;
        }
    }
    
    if (hasChanges !== isDirty) {
        isDirty = hasChanges;
        updateUI();
    }
}

// Update UI based on dirty state
function updateUI() {
    if (isDirty) {
        submitBtn.disabled = true;
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-secondary');
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Update Information First';
        dirtyWarning.classList.remove('d-none');
    } else {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-secondary');
        submitBtn.classList.add('btn-success');
        submitBtn.innerHTML = '<i class="fas fa-search me-1"></i>Continue to Quality Review';
        dirtyWarning.classList.add('d-none');
    }
}

// Add event listeners to all form fields
function setupDirtyTracking() {
    const fields = ['title', 'description', 'impact', 'opportunity_id', 'milestone_id'];
    fields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.addEventListener('input', checkDirtyState);
            element.addEventListener('change', checkDirtyState);
        }
    });
}

// Handle update form submission
const updateForm = document.querySelector('form[action*="update_review"]');
if (updateForm) {
    updateForm.addEventListener('submit', function(e) {
        // Let the form submit normally, but mark as not dirty after a brief delay
        setTimeout(() => {
            storeOriginalValues();
            isDirty = false;
            updateUI();
        }, 100);
    });
}

// Prevent submit if dirty
const submitForm = document.querySelector('form[action*="submit"]');
if (submitForm) {
    submitForm.addEventListener('submit', function(e) {
        if (isDirty) {
            e.preventDefault();
            alert('You have unsaved changes. Please click "Update Information" first to save your changes before submitting.');
            return false;
        }
        clearWizardData();
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    storeOriginalValues();
    setupDirtyTracking();
    updateUI();
});

// Clear localStorage when submitting
function clearWizardData() {
    localStorage.removeItem('wizard_title');
    localStorage.removeItem('wizard_description');
    localStorage.removeItem('wizard_impact');
}

// Character counters for all fields
function addCharacterCounter(elementId, maxChars = null) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const originalFormText = element.nextElementSibling;
    
    function updateCounter() {
        const count = element.value.length;
        let message = '';
        let className = 'form-text';
        
        if (maxChars) {
            const remaining = maxChars - count;
            if (remaining < 20) {
                message = `${remaining} characters remaining`;
                className = 'form-text text-warning';
            } else {
                message = `${count}/${maxChars} characters`;
            }
        } else {
            message = `${count} characters`;
            if (count > 125) {
                className = 'form-text text-success';
            }
        }
        
        // Create or update character counter
        let counterElement = element.parentNode.querySelector('.char-counter');
        if (!counterElement) {
            counterElement = document.createElement('div');
            counterElement.className = 'char-counter mt-1';
            element.parentNode.appendChild(counterElement);
        }
        
        counterElement.className = `char-counter mt-1 ${className}`;
        counterElement.innerHTML = `<i class="fas fa-keyboard me-1"></i>${message}`;
    }
    
    element.addEventListener('input', updateCounter);
    updateCounter(); // Initial call
}

// Add counters to all fields
addCharacterCounter('title', 125);
addCharacterCounter('description');
addCharacterCounter('impact');

// Auto-resize textareas
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    
    // Initial resize
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
});

// Function to update hidden fields when form values change
function updateHiddenFields() {
    document.getElementById('hidden-title').value = document.getElementById('title').value;
    document.getElementById('hidden-description').value = document.getElementById('description').value;
    document.getElementById('hidden-impact').value = document.getElementById('impact').value;
    document.getElementById('hidden-opportunity-id').value = document.getElementById('opportunity_id').value;
    document.getElementById('hidden-milestone-id').value = document.getElementById('milestone_id').value;
}

// Add event listeners to all form fields to sync with hidden fields
document.getElementById('title').addEventListener('input', function() {
    updateHiddenFields();
    checkDirtyState();
});
document.getElementById('description').addEventListener('input', function() {
    updateHiddenFields();
    checkDirtyState();
});
document.getElementById('impact').addEventListener('input', function() {
    updateHiddenFields();
    checkDirtyState();
});
document.getElementById('opportunity_id').addEventListener('input', function() {
    updateHiddenFields();
    checkDirtyState();
});
document.getElementById('milestone_id').addEventListener('input', function() {
    updateHiddenFields();
    checkDirtyState();
});

// Update hidden fields on page load
updateHiddenFields();
</script>
{% endblock %}
